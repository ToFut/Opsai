<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpsAI Terraform-Airbyte Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto p-6">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Terraform-Airbyte Integration Dashboard
            </h1>
            <span id="status-indicator" class="flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span>
                <span class="text-sm text-gray-400">Connected</span>
            </span>
        </div>

        <!-- Current State -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Active Connections -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-blue-400">Active Airbyte Connections</h2>
                <div id="active-connections" class="space-y-3">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>

            <!-- Terraform Resources -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-400">Terraform Resources</h2>
                <div id="terraform-resources" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="text-gray-500">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Provider Management -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-green-400">Provider Management</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Stripe -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">üí≥</span>
                            <span class="font-medium">Stripe</span>
                        </div>
                        <span id="stripe-status" class="px-2 py-1 text-xs rounded bg-green-900 text-green-300">
                            Active
                        </span>
                    </div>
                    <button onclick="syncProvider('stripe')" 
                            class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm transition">
                        Trigger Sync
                    </button>
                </div>

                <!-- QuickBooks -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">üìä</span>
                            <span class="font-medium">QuickBooks</span>
                        </div>
                        <span id="quickbooks-status" class="px-2 py-1 text-xs rounded bg-gray-800 text-gray-400">
                            Not Configured
                        </span>
                    </div>
                    <button onclick="connectProvider('quickbooks')" 
                            class="w-full px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-sm transition">
                        Connect
                    </button>
                </div>

                <!-- Shopify -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">üõçÔ∏è</span>
                            <span class="font-medium">Shopify</span>
                        </div>
                        <span id="shopify-status" class="px-2 py-1 text-xs rounded bg-yellow-900 text-yellow-300">
                            Configured
                        </span>
                    </div>
                    <button onclick="syncProvider('shopify')" 
                            class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm transition">
                        Trigger Sync
                    </button>
                </div>

                <!-- GitHub -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">üêô</span>
                            <span class="font-medium">GitHub</span>
                        </div>
                        <span id="github-status" class="px-2 py-1 text-xs rounded bg-yellow-900 text-yellow-300">
                            Configured
                        </span>
                    </div>
                    <button onclick="syncProvider('github')" 
                            class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm transition">
                        Trigger Sync
                    </button>
                </div>

                <!-- NetSuite -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">üìà</span>
                            <span class="font-medium">NetSuite</span>
                        </div>
                        <span id="netsuite-status" class="px-2 py-1 text-xs rounded bg-gray-800 text-gray-400">
                            Not Configured
                        </span>
                    </div>
                    <button onclick="connectProvider('netsuite')" 
                            class="w-full px-3 py-2 bg-green-600 hover:bg-green-700 rounded text-sm transition">
                        Connect
                    </button>
                </div>

                <!-- Google Analytics -->
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">üì±</span>
                            <span class="font-medium">Google Analytics</span>
                        </div>
                        <span id="google-status" class="px-2 py-1 text-xs rounded bg-yellow-900 text-yellow-300">
                            Configured
                        </span>
                    </div>
                    <button onclick="syncProvider('google')" 
                            class="w-full px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm transition">
                        Trigger Sync
                    </button>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-orange-400">Console Output</h2>
            <pre id="console-output" class="bg-black rounded p-4 text-xs text-green-400 font-mono h-64 overflow-y-auto">
Terraform-Airbyte Dashboard initialized...
Connecting to services on ports 3005 and 3006...
            </pre>
        </div>
    </div>

    <script>
        const TERRAFORM_API = 'http://localhost:3006';
        const OAUTH_API = 'http://localhost:3005';

        function log(message, type = 'info') {
            const output = document.getElementById('console-output');
            const timestamp = new Date().toTimeString().split(' ')[0];
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üìù';
            output.innerHTML += `\n[${timestamp}] ${prefix} ${message}`;
            output.scrollTop = output.scrollHeight;
        }

        async function loadStatus() {
            try {
                // Load Terraform status
                const response = await fetch(`${TERRAFORM_API}/api/terraform/status`);
                const data = await response.json();
                
                // Update active connections
                const connectionsEl = document.getElementById('active-connections');
                if (data.airbyteConnections && data.airbyteConnections.length > 0) {
                    connectionsEl.innerHTML = data.airbyteConnections.map(conn => `
                        <div class="bg-gray-700 rounded p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-mono">${conn.resource.split('.')[1].split('[')[0]}</span>
                                <span class="px-2 py-1 text-xs rounded bg-green-900 text-green-300">
                                    ${conn.status}
                                </span>
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                ID: ${conn.connectionId}
                            </div>
                        </div>
                    `).join('');
                } else {
                    connectionsEl.innerHTML = '<div class="text-gray-500">No active connections</div>';
                }
                
                // Update resources list
                const resourcesEl = document.getElementById('terraform-resources');
                if (data.terraformResources && data.terraformResources.length > 0) {
                    resourcesEl.innerHTML = data.terraformResources.map(resource => `
                        <div class="text-sm font-mono text-gray-400 hover:text-white cursor-pointer">
                            ${resource}
                        </div>
                    `).join('');
                }
                
                log('Status refreshed successfully', 'success');
            } catch (error) {
                log(`Failed to load status: ${error.message}`, 'error');
            }
        }

        async function syncProvider(provider) {
            log(`Triggering sync for ${provider}...`);
            try {
                const response = await fetch(`${TERRAFORM_API}/api/terraform/sync/${provider}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    log(`Sync triggered for ${provider}`, 'success');
                    setTimeout(loadStatus, 5000);
                } else {
                    log(`Sync failed for ${provider}: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error triggering sync: ${error.message}`, 'error');
            }
        }

        async function connectProvider(provider) {
            log(`Connecting ${provider}...`);
            
            const credentials = {};
            
            if (provider === 'quickbooks') {
                credentials.client_id = prompt('Enter QuickBooks Client ID:');
                credentials.access_token = prompt('Enter QuickBooks Access Token:');
                credentials.refresh_token = prompt('Enter QuickBooks Refresh Token:');
                credentials.realm_id = prompt('Enter QuickBooks Realm ID:');
            } else if (provider === 'netsuite') {
                credentials.account_id = prompt('Enter NetSuite Account ID:');
                credentials.consumer_key = prompt('Enter NetSuite Consumer Key:');
                credentials.consumer_secret = prompt('Enter NetSuite Consumer Secret:');
                credentials.token_id = prompt('Enter NetSuite Token ID:');
                credentials.token_secret = prompt('Enter NetSuite Token Secret:');
            }
            
            if (!credentials.client_id && !credentials.account_id) {
                log('Connection cancelled', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${TERRAFORM_API}/api/oauth/connect-with-terraform`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'dashboard-user',
                        provider,
                        credentials
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log(`${provider} connected successfully!`, 'success');
                    setTimeout(loadStatus, 5000);
                } else {
                    log(`Failed to connect ${provider}: ${data.error}`, 'error');
                }
            } catch (error) {
                log(`Error connecting ${provider}: ${error.message}`, 'error');
            }
        }

        // Check services health
        async function checkServices() {
            try {
                const terraform = await fetch(`${TERRAFORM_API}/health`);
                const oauth = await fetch(`${OAUTH_API}/health`);
                
                if (terraform.ok && oauth.ok) {
                    log('All services are running', 'success');
                    document.getElementById('status-indicator').innerHTML = `
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span>
                        <span class="text-sm text-gray-400">Connected</span>
                    `;
                }
            } catch (error) {
                log('Some services are not running', 'error');
                document.getElementById('status-indicator').innerHTML = `
                    <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
                    <span class="text-sm text-gray-400">Disconnected</span>
                `;
            }
        }

        // Initial load
        checkServices();
        loadStatus();
        
        // Refresh every 30 seconds
        setInterval(loadStatus, 30000);
    </script>
</body>
</html>